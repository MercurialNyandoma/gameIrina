<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AetherBloom - Игра</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="game-header">
            <button onclick="location.href='story.html'">Назад</button>
            <div class="game-info">
                <span>Уровень: <span id="gameLevel">1</span></span>
                <span>Очки: <span id="gamePoints">0</span></span>
                <span>Энергия: <span id="gameEnergy">5</span>/5</span>
            </div>
        </header>

        <main class="game-main">
            <div id="energyWarning" class="warning hidden">
                Недостаточно энергии! Подождите восстановления.
            </div>
            
            <div class="game-board-container">
                <div id="gameBoard" class="game-board"></div>
            </div>
            
            <div class="game-controls">
                <button id="restartButton" onclick="restartGame()">Перезапуск</button>
                <button onclick="location.href='story.html'">Выйти</button>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        const ROWS = 6;
        const COLS = 7;
        const TILE_TYPES = 6;
        let board = [];
        let selectedTile = null;
        let isSwapping = false;
        let score = 0;
        let currentLevel = 1;

        function initGame() {
            const gameData = JSON.parse(localStorage.getItem('gameData')) || initGameData();
            
            if (!checkEnergy()) {
                document.getElementById('energyWarning').classList.remove('hidden');
                return;
            }

            currentLevel = gameData.currentLevel || 1;
            score = gameData.points || 0;
            
            document.getElementById('gameLevel').textContent = currentLevel;
            document.getElementById('gamePoints').textContent = score;
            document.getElementById('gameEnergy').textContent = gameData.energy;
            
            createBoard();
            renderBoard();
        }

        function createBoard() {
            board = [];
            for (let r = 0; r < ROWS; r++) {
                board[r] = [];
                for (let c = 0; c < COLS; c++) {
                    board[r][c] = Math.floor(Math.random() * TILE_TYPES);
                }
            }
            
            while (findMatches().length > 0) {
                for (let match of findMatches()) {
                    board[match.r][match.c] = Math.floor(Math.random() * TILE_TYPES);
                }
            }
        }

        function renderBoard() {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';
            gameBoard.style.gridTemplateColumns = `repeat(${COLS}, 1fr)`;
            
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const tile = document.createElement('div');
                    tile.className = `tile type-${board[r][c]}`;
                    tile.dataset.row = r;
                    tile.dataset.col = c;
                    tile.addEventListener('click', handleTileClick);
                    gameBoard.appendChild(tile);
                }
            }
        }

        function handleTileClick(event) {
            if (isSwapping) return;
            
            const row = parseInt(event.target.dataset.row);
            const col = parseInt(event.target.dataset.col);
            
            if (!selectedTile) {
                selectedTile = { row, col };
                event.target.classList.add('selected');
            } else {
                const rowDiff = Math.abs(row - selectedTile.row);
                const colDiff = Math.abs(col - selectedTile.col);
                
                if ((rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1)) {
                    swapTiles(selectedTile.row, selectedTile.col, row, col);
                }
                
                document.querySelector('.tile.selected')?.classList.remove('selected');
                selectedTile = null;
            }
        }

        function swapTiles(r1, c1, r2, c2) {
            isSwapping = true;
            
            const temp = board[r1][c1];
            board[r1][c1] = board[r2][c2];
            board[r2][c2] = temp;
            
            renderBoard();
            
            setTimeout(() => {
                const matches = findMatches();
                if (matches.length > 0) {
                    processMatches(matches);
                    useEnergy();
                } else {
                    const temp = board[r1][c1];
                    board[r1][c1] = board[r2][c2];
                    board[r2][c2] = temp;
                    renderBoard();
                }
                isSwapping = false;
            }, 300);
        }

        function findMatches() {
            const matches = [];
            
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS - 2; c++) {
                    if (board[r][c] === board[r][c + 1] && board[r][c] === board[r][c + 2]) {
                        matches.push({ r, c });
                        matches.push({ r, c: c + 1 });
                        matches.push({ r, c: c + 2 });
                    }
                }
            }
            
            for (let c = 0; c < COLS; c++) {
                for (let r = 0; r < ROWS - 2; r++) {
                    if (board[r][c] === board[r + 1][c] && board[r][c] === board[r + 2][c]) {
                        matches.push({ r, c });
                        matches.push({ r: r + 1, c });
                        matches.push({ r: r + 2, c });
                    }
                }
            }
            
            return [...new Set(matches.map(m => `${m.r},${m.c}`))].map(str => {
                const [r, c] = str.split(',');
                return { r: parseInt(r), c: parseInt(c) };
            });
        }

        function processMatches(matches) {
            score += matches.length * 10;
            document.getElementById('gamePoints').textContent = score;
            
            for (let match of matches) {
                board[match.r][match.c] = -1;
            }
            
            renderBoard();
            
            setTimeout(() => {
                dropTiles();
                renderBoard();
                
                setTimeout(() => {
                    const newMatches = findMatches();
                    if (newMatches.length > 0) {
                        processMatches(newMatches);
                    } else {
                        saveGameProgress();
                    }
                }, 300);
            }, 300);
        }

        function dropTiles() {
            for (let c = 0; c < COLS; c++) {
                let emptySpaces = 0;
                
                for (let r = ROWS - 1; r >= 0; r--) {
                    if (board[r][c] === -1) {
                        emptySpaces++;
                    } else if (emptySpaces > 0) {
                        board[r + emptySpaces][c] = board[r][c];
                        board[r][c] = -1;
                    }
                }
                
                for (let r = 0; r < ROWS; r++) {
                    if (board[r][c] === -1) {
                        board[r][c] = Math.floor(Math.random() * TILE_TYPES);
                    }
                }
            }
        }

        function useEnergy() {
            const gameData = JSON.parse(localStorage.getItem('gameData'));
            gameData.energy--;
            gameData.points = score;
            localStorage.setItem('gameData', JSON.stringify(gameData));
            document.getElementById('gameEnergy').textContent = gameData.energy;
        }

        function checkEnergy() {
            const gameData = JSON.parse(localStorage.getItem('gameData')) || initGameData();
            updateEnergy();
            return gameData.energy > 0;
        }

        function saveGameProgress() {
            const gameData = JSON.parse(localStorage.getItem('gameData'));
            gameData.points = score;
            localStorage.setItem('gameData', JSON.stringify(gameData));
        }

        function restartGame() {
            if (!checkEnergy()) {
                document.getElementById('energyWarning').classList.remove('hidden');
                return;
            }
            score = 0;
            document.getElementById('gamePoints').textContent = score;
            createBoard();
            renderBoard();
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (!localStorage.getItem('telegramUser')) {
                location.href = 'index.html';
                return;
            }
            initGame();
        });
    </script>
</body>
</html>